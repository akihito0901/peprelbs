<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PePre (ペプレ) - 愛犬との暮らしを、もっと美しく。</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Firebase SDK (v8 Compat for CDN usage without build step) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        // --- FIREBASE CONFIGURATION (REPLACE WITH YOUR KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDs1z1ZYTb7ISy-uGnxHQV0yqm2vrQBCw8",
            authDomain: "pepre-app.firebaseapp.com",
            projectId: "pepre-app",
            storageBucket: "pepre-app.firebasestorage.app",
            messagingSenderId: "211917167439",
            appId: "1:211917167439:web:5bf9dfdde895e8fb46833a"
        };
        // Initialize Firebase
        if (typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized");
            } catch (e) {
                console.warn("Firebase Init Error (Keys missing?):", e);
            }
        }
        // Initialize Firestore
        const db = typeof firebase !== 'undefined' ? firebase.firestore() : null;
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Shippori Mincho for elegance, Zen Maru Gothic for rounded softness -->
    <link
        href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: {
                            base: '#FFFBF5',      // Warm White
                            text: '#4A4238',      // Warm Dark Gray
                            primary: '#E5B5A8',   // Dusty Pink (Main Accent)
                            secondary: '#A8C8BA', // Sage Green (Health/Healing)
                            accent: '#DBC1AC',    // Sand/Greige (Neutral Accent)
                            surface: '#FFFFFF',   // Pure White
                            muted: '#F2EBE5'      // Muted background
                        }
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                        serif: ['Shippori Mincho', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(229, 181, 168, 0.15)',
                        'float': '0 10px 30px -5px rgba(74, 66, 56, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFFBF5;
            color: #4A4238;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif {
            font-family: 'Shippori Mincho', serif;
        }

        .font-sans {
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        .fade-in-delay-1 {
            animation-delay: 0.1s;
        }

        .fade-in-delay-2 {
            animation-delay: 0.2s;
        }

        .fade-in-delay-3 {
            animation-delay: 0.3s;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide scrollbar */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom styling for inputs */
        .input-underline {
            background: transparent;
            border-bottom: 1px solid #DBC1AC;
            transition: all 0.3s ease;
        }

        .input-underline:focus {
            border-color: #E5B5A8;
            outline: none;
        }
    </style>
</head>

<body class="bg-theme-base text-theme-text font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ICONS (Thin & Elegant) ---
        const IconHome = ({ active }) => <svg xmlns="http://www.w3.org/2000/svg" fill={active ? "currentColor" : "none"} viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>;
        const IconRecord = ({ active }) => <svg xmlns="http://www.w3.org/2000/svg" fill={active ? "currentColor" : "none"} viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>;
        const IconEvent = ({ active }) => <svg xmlns="http://www.w3.org/2000/svg" fill={active ? "currentColor" : "none"} viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" /></svg>;
        const IconLost = ({ active }) => <svg xmlns="http://www.w3.org/2000/svg" fill={active ? "currentColor" : "none"} viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m1.5.5-1.5-.5M6.75 7.364V3h-3v18m3-13.636 10.5-3.819" /></svg>;

        const IconFood = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 mb-2 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>;
        const IconHealth = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 mb-2 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>; // Reusing Heart
        const IconEventNews = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 mb-2 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" /></svg>;
        const IconLostFound = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 mb-2 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>;

        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>;
        const IconCoat = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>;
        const IconBone = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>; // Simulating bone with search... actually wait, let's use a nice shape
        const IconWeight = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>; // Scale like
        const IconBowl = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z" /></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>;
        const IconPaw = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 text-theme-primary"><path strokeLinecap="round" strokeLinejoin="round" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" /></svg>; // Simple Paw/Face

        // --- DATA ---
        const PRODUCTS = [
            { id: 1, name: "アカナ", tags: { age: 'all', concern: 'coat', priority: 'A', secondaryConcern: ['joints'] }, img: "./images/acana.jpg", description: "生物学的に適正な栄養。新鮮な肉類を最大75%使用し、筋肉と被毛をサポート。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+CWE66A+5FPU+61JSH", feature: "High Protein" },
            { id: 2, name: "アランズ ナチュラル", tags: { age: 'all', concern: 'allergy', priority: 'A', secondaryConcern: ['tear_burn'] }, img: "./images/alans.jpg", description: "野生の食事を再現。ラム肉とサツマイモ、わずか9種の厳選素材。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+BRB9FM+3J8+C1DUP", feature: "Hypoallergenic" },
            { id: 4, name: "うまか", tags: { age: 'all', concern: 'tear_burn', priority: 'S', secondaryConcern: ['joints', 'digest'] }, img: "./images/umaka.jpg", description: "九州産「華味鳥」100%。涙やけと関節に配慮した、内側から溢れる美しさ。", price: "¥5,478", link: "http://msm.to/2U5R2J2", feature: "Premium Care" },
            { id: 5, name: "エッセンシャル", tags: { age: 'adult', concern: 'coat', priority: 'B', secondaryConcern: ['allergy'] }, img: "./images/essential.jpg", description: "お肉不使用、魚77.5%。アレルゲン排除とオメガ3で皮膚トラブルに特化。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+BDMAIQ+3J8+3H2YHD", feature: "Fish Based" },
            { id: 6, name: "カナガン", tags: { age: 'all', concern: 'appetite', priority: 'S', secondaryConcern: ['active'] }, img: "./images/canagan.jpg", description: "世界中で愛されるグレインフリー。チキン60%の食いつきと栄養バランス。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+CWE66A+5FPU+61JSH", feature: "Grain Free" },
            { id: 7, name: "カナガン デンタル", tags: { age: 'all', concern: 'teeth', priority: 'A', secondaryConcern: ['appetite'] }, img: "./images/canagan_dental.jpg", description: "特許成分配合。食べるだけで愛犬の「口内の健康」を守る画期的フード。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+BQ4E82+3J8+5SG2LT", feature: "Oral Care" },
            { id: 8, name: "カナガン チキン＆サーモン", tags: { age: 'all', concern: 'coat', priority: 'A', secondaryConcern: ['appetite'] }, img: "./images/canagan_chickensalmon.jpg", description: "チキンとサーモンの相乗効果。偏食対策と美しい毛並みの維持に。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3ZJU37+EGYCN6+4NYE+61Z81", feature: "Multi Protein" },
            { id: 9, name: "グランツ", tags: { age: 'all', concern: 'tear_burn', priority: 'B', secondaryConcern: ['allergy'] }, img: "./images/grands.jpg", description: "無添加・グレインフリー。小粒設計でお腹に優しいフランス産プレミアム。", price: "¥要確認", link: "http://msm.to/APkBGUm", feature: "Digest Support" },
            { id: 10, name: "グレボ", tags: { age: 'all', concern: 'joints', priority: 'B', secondaryConcern: ['tear_burn'] }, img: "./images/glebo.jpg", description: "国産・関節ケア。抗酸化成分とグルコサミン配合でシニアの元気を維持。", price: "¥要確認", link: "http://msm.to/3OyO6nm", feature: "Anti-Aging" },
            { id: 11, name: "このこのごはん", tags: { age: 'all', concern: 'tear_burn', priority: 'S', secondaryConcern: ['coat', 'odor'] }, img: "./images/konokono.jpg", description: "小型犬の「涙やけ・毛並み・におい」に特化。自然素材のやさしい国産ご飯。", price: "¥要確認", link: "http://msm.to/7C7CAGn", feature: "Tear Burn Care" },
            { id: 12, name: "ネルソンズ", tags: { age: 'adult', concern: 'appetite', priority: 'B', secondaryConcern: ['digest'] }, img: "./images/nelsons.jpg", description: "中型・大型犬向けの大容量。グレインフリーで消化と家計を両立。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3HRCDC+2Z6SY+3J8+ZQ80I", feature: "Large Breed" },
            { id: 13, name: "ハッピードッグ", tags: { age: 'all', concern: 'allergy', priority: 'B', secondaryConcern: ['obesity'] }, img: "./images/happydog.jpg", description: "ドイツ品質のナチュラルフード。珍しいタンパク源でアレルギーや体調管理に。", price: "¥要確認", link: "", feature: "German Quality" },
            { id: 14, name: "ペトコト", tags: { age: 'all', concern: 'appetite', priority: 'S', secondaryConcern: ['digest'] }, img: "./images/petokoto.jpg", description: "新鮮な食材を急速冷凍。手作りごはんの栄養と香りで、驚きの食いつきを。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3ZJU37+EGYCN6+4NYE+61Z81", feature: "Fresh Food" },
            { id: 15, name: "ミシュワン", tags: { age: 'all', concern: 'joints', priority: 'S', secondaryConcern: ['tear_burn', 'coat'] }, img: "./images/mishone.jpg", description: "関節ケアの最高峰。緑イ貝配合で、いつまでも軽やかなステップを。", price: "¥4,378", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+C1FP16+4PA6+BXYE9", feature: "Joint Support" },
            { id: 16, name: "モグキューブ", tags: { age: 'all', concern: 'appetite', priority: 'B', secondaryConcern: [] }, img: "./images/mogcube.jpg", description: "NZ産ラムのフリーズドライ。栄養そのままでトッピングやおやつにも最適。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3HQZ35+BN56NM+3J8+354KNM", feature: "Freeze Dried" },
            { id: 17, name: "モグワン", tags: { age: 'all', concern: 'tear_burn', priority: 'S', secondaryConcern: ['coat', 'appetite'] }, img: "./images/mogwan.jpg", description: "手作り食レシピの美味しさと栄養バランス。野菜とフルーツたっぷりの人気No.1。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3NGVLD+2NUUPU+3J8+1BPOF5", feature: "Best Seller" },
            { id: 18, name: "やわか", tags: { age: 'senior', concern: 'appetite', priority: 'A', secondaryConcern: ['digest'] }, img: "./images/yawaka.jpg", description: "水分を逃さない特殊製法。シニアも食べやすい国産セミモイストフード。", price: "¥6,578", link: "http://msm.to/ApJikKQ", feature: "Soft Touch" },
            { id: 19, name: "ユリカゴ", tags: { age: 'all', concern: 'none', priority: 'B', secondaryConcern: [] }, img: "./images/yurikago.jpg", description: "「安眠」と「リラックス」をテーマに。ハーブの力で穏やかな毎日を。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+BQ4E82+3J8+5SG2LT", feature: "Relax Care" },
            { id: 20, name: "馬肉自然づくり", tags: { age: 'all', concern: 'obesity', priority: 'A', secondaryConcern: ['allergy'] }, img: "./images/baniku.jpg", description: "熊本産馬肉を贅沢に使用。高タンパク・低脂質でダイエットに最適。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=3ZJU37+EGYCN6+4NYE+61Z81", feature: "Low Fat" },
            { id: 21, name: "和漢みらい", tags: { age: 'senior', concern: 'none', priority: 'A', secondaryConcern: ['obesity'] }, img: "./images/wakan.jpg", description: "89種類の和漢植物を配合。薬善の知恵でシニア期の健康を徹底サポート。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+BDMAIQ+3J8+3H2YHD", feature: "Yakuzen Care" },
            { id: 22, name: "マックアダムス", tags: { age: 'all', concern: 'appetite', priority: 'S', secondaryConcern: ['joints'] }, img: "./images/macadams.jpg", description: "一羽丸ごとのチキンを使用。愛犬が喜ぶ美味しさと栄養。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+59BWOY+3J8+5AKUQP", feature: "Whole Chicken" },
            { id: 23, name: "ミシュワン 小型犬用", tags: { age: 'all', concern: 'joints', priority: 'A', secondaryConcern: ['tear_burn', 'digest'] }, img: "./images/mishone_small.png", description: "小型犬の繊細な健康維持に。食べやすい小粒タイプ。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=45GGT8+C1FMPU+4PA6+BXYE9", feature: "Small Breed" },
            { id: 24, name: "ペロリコドッグフード ライト", tags: { age: 'all', concern: 'obesity', priority: 'A', secondaryConcern: ['digest'] }, img: "./images/perolico_light.jpg", description: "低カロリー・低脂質。無理なく美味しく体重管理。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+5URIGY+3J8+4ASX02", feature: "Diet Support" },
            { id: 25, name: "ペロリコ アレルカット", tags: { age: 'all', concern: 'allergy', priority: 'A', secondaryConcern: ['coat'] }, img: "./images/perolico_aller.jpg", description: "食物アレルギーに配慮。厳選されたタンパク源を使用。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+679M6A+3J8+54KL8Y", feature: "Allergy Care" },
            { id: 26, name: "ドクターケアワン", tags: { age: 'senior', concern: 'joints', priority: 'A', secondaryConcern: ['digest', 'tear_burn'] }, img: "./images/drcarewan.jpg", description: "獣医師監修。シニア犬の健康寿命を考えた栄養設計。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+5VYDOI+3RW8+BX3J6", feature: "Vet Formulated" },
            { id: 27, name: "キュアペット 口臭ケア", tags: { age: 'all', concern: 'odor', priority: 'A', secondaryConcern: ['teeth', 'digest'] }, img: "./images/curepet.jpg", description: "専門家と共同開発。内側からアプローチするお口ケア。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+6AU7SY+3RW8+5YJRM", feature: "Breath Care" },
            { id: 28, name: "ニュートラム", tags: { age: 'all', concern: 'coat', priority: 'B', secondaryConcern: ['digest'] }, img: "./images/nutram.jpg", description: "カナダ発のホリスティックフード。素材の組み合わせで健康をサポート。", price: "¥要確認", link: "https://px.a8.net/svt/ejp?a8mat=4AX40F+5NMB7M+5OMY+5YJRM", feature: "Holistic" }
        ];

        const BREEDS = {
            "あ": ["秋田犬", "アフガンハウンド", "アメリカンコッカースパニエル", "イタリアングレーハウンド", "イングリッシュコッカースパニエル", "ウィペット", "ウエストハイランドホワイトテリア", "オーストラリアン・ラブラドゥードル"],
            "か": ["甲斐犬", "カニンヘンダックスフンド", "キャバリア・キングチャールズ・スパニエル", "グレート・ピレニーズ", "ケアーンテリア", "コーギー", "ゴールデン・レトリーバー"],
            "さ": ["サモエド", "シーズー", "シェットランド・シープドッグ", "柴犬", "シベリアンハスキー", "ジャック・ラッセル・テリア", "シュナウザー", "スタンダードプードル", "スピッツ"],
            "た": ["ダルメシアン", "チワワ", "チン", "ティーカッププードル", "トイプードル", "ドーベルマン"],
            "な": ["日本スピッツ", "ニューファンドランド", "ノーフォークテリア"],
            "は": ["パグ", "バセットハウンド", "パピヨン", "バーニーズ・マウンテン・ドッグ", "ビション・フリーゼ", "ビーグル", "ブルドッグ", "ブルテリア", "フレンチブルドッグ", "ペキニーズ", "ボーダーコリー", "ボストンテリア", "ポメラニアン", "ボルゾイ"],
            "ま": ["マルチーズ", "マルプー", "ミニチュア・シュナウザー", "ミニチュア・ダックスフンド", "ミニチュア・ピンシャー", "ミニチュア・プードル"],
            "や": ["ヨークシャーテリア"],
            "ら": ["ラブラドール・レトリーバー"],
            "わ": ["ワイマラナー", "ワイヤーフォックステリア"],
            "MIX": ["ミックス犬", "その他"]
        };
        const BREED_TABS = Object.keys(BREEDS);

        const EVENTS_DATA = [
            { date: "1月31日-2月1日", title: "Marble Dog Festival 2026", place: "東京都 東京ビッグサイト", tags: ["大規模", "屋内", "フェス"], img: "https://images.unsplash.com/photo-1587300003388-59208cc962cb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "1月31日-2月1日", title: "水戸Wanパーク", place: "茨城県 千波公園", tags: ["屋外", "マルシェ", "北関東"], img: "https://images.unsplash.com/photo-1534361960057-19889db9621e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "3月20日-22日", title: "駒沢公園ドッグイベント", place: "東京都 駒沢オリンピック公園", tags: ["屋外", "マルシェ", "無料"], img: "https://images.unsplash.com/photo-1548199973-03cce0bbc87b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "4月02日-05日", title: "インターペット東京 2026", place: "東京都 東京ビッグサイト", tags: ["国内最大", "屋内", "見本市"], img: "https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "4月10日-12日", title: "代々木公園わんわんカーニバル", place: "東京都 代々木公園", tags: ["屋外", "都心", "長寿イベント"], img: "https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "4月25日-26日", title: "GOGO DOG FES", place: "神奈川県 パシフィコ横浜", tags: ["海沿い", "屋外", "フェス"], img: "https://images.unsplash.com/photo-1591769225440-811ad7d6eca6?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "4月26日", title: "ONE'S MARKET DOG", place: "栃木県 那須ハイランドパーク", tags: ["レジャー", "屋外", "北関東"], img: "https://images.unsplash.com/photo-1548199973-03cce0bbc87b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "5月03日-05日", title: "Pet博2026幕張", place: "千葉県 幕張メッセ", tags: ["GW", "屋内", "大規模"], img: "https://images.unsplash.com/photo-1587300003388-59208cc962cb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "5月23日-24日", title: "Sippo Festa 2026 春", place: "東京都 昭和記念公園", tags: ["屋外", "広大", "フェス"], img: "https://images.unsplash.com/photo-1534361960057-19889db9621e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "6月06日-07日", title: "富士山わんわんマルシェ", place: "静岡県 あさぎりフードパーク", tags: ["絶景", "屋外", "マルシェ"], img: "https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "6月26日-28日", title: "TOKYO DOG SHOW", place: "千葉県 幕張メッセ", tags: ["屋内", "アウトドア", "展示"], img: "https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "2月14日-15日", title: "コーギーズ/プードルJAM九州", place: "福岡県 宗像ユリックス", tags: ["犬種別", "オフ会", "九州"], img: "https://images.unsplash.com/photo-1548199973-03cce0bbc87b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "3月14日-15日", title: "RKB福岡百道浜ドッグフェスタ", place: "福岡県 シーサイドももち", tags: ["九州最大", "屋外", "フェス"], img: "https://images.unsplash.com/photo-1591769225440-811ad7d6eca6?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "3月14日-15日", title: "門司港レトロ ドッグマルシェ", place: "福岡県 門司港レトロ", tags: ["観光地", "屋外", "マルシェ"], img: "https://images.unsplash.com/photo-1534361960057-19889db9621e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" },
            { date: "8月08日-09日", title: "Pet博2026 福岡", place: "福岡県 みずほPayPayドーム", tags: ["屋内", "大規模", "九州"], img: "https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" }
        ];

        const LOST_DATA = [];

        // === COMPONENTS ===

        // --- 1. LANDING PAGE ---
        const LandingPage = ({ onLogin }) => {
            return (
                <div className="min-h-screen bg-theme-base flex flex-col items-center pb-20 fade-in relative pt-16">
                    {/* Logo (Restored & Centered) */}
                    <img src="./images/logo_line.png" className="w-40 mb-10 opacity-90 mix-blend-multiply" />

                    {/* Text Section (Clean Layout) */}
                    <div className="text-center px-6 mb-16 relative z-10 text-theme-text">
                        <h1 className="font-serif text-3xl md:text-4xl font-medium leading-relaxed tracking-wide drop-shadow-sm mb-6">
                            愛犬の管理、<br />スマホ一つで。
                        </h1>
                        <p className="text-sm text-theme-text/70 font-sans tracking-wider leading-loose">
                            フード診断、イベント情報、<br />ワクチン接種記録まで全て完結。
                        </p>
                    </div>

                    <div className="w-full max-w-md px-6 relative z-10 grid grid-cols-2 gap-x-4 gap-y-8 mb-16">
                        <FeatureCard
                            icon={<IconFood />}
                            title="Food Diagnosis"
                            jp="フード診断"
                            desc="年齢と体質に合わせた最適な一皿を提案"
                        />
                        <FeatureCard
                            icon={<IconHealth />}
                            title="Health Record"
                            jp="ヘルスケア記録"
                            desc="ワクチン接種日と次回予定を管理"
                        />
                        <FeatureCard
                            icon={<IconEventNews />}
                            title="Event News"
                            jp="イベント情報"
                            desc="週末のお出かけ先を全国から検索"
                        />
                        <FeatureCard
                            icon={<IconLostFound />}
                            title="Lost & Found"
                            jp="迷子掲示板"
                            desc="地域のみんなで守る安心ネットワーク"
                        />
                    </div>

                    {/* Google Login Section (Moved Below) */}
                    <div className="w-full max-w-xs px-6 mb-16">
                        <div className="text-center mb-6">
                            <p className="font-serif text-theme-text text-lg mb-1">さあ、始めましょう</p>
                            <p className="text-xs text-theme-text/50">登録も管理も、これひとつ。</p>
                        </div>
                        <button onClick={onLogin} className="w-full group relative overflow-hidden bg-white border border-theme-primary/30 text-theme-text font-serif px-6 py-5 rounded-2xl shadow-soft hover:shadow-card transition-all duration-300 active:scale-95 flex items-center justify-center gap-3">
                            <svg className="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                            </svg>
                            <span className="tracking-widest font-bold text-sm">Googleでログイン</span>
                        </button>
                    </div>

                    <footer className="text-center text-[10px] text-theme-text/30 pb-8 font-sans">
                        © 2026 PePre Inc.
                    </footer>
                </div>
            );
        };

        const FeatureCard = ({ icon, title, jp, desc }) => (
            <div className="flex flex-col items-center text-center p-2">
                <div className="mb-2 p-3 bg-white/50 rounded-full text-theme-primary">
                    {icon}
                </div>
                <h3 className="font-serif text-base text-theme-text mb-1">{jp}</h3>
                <p className="text-[10px] text-theme-text/60 leading-relaxed font-sans">{desc}</p>
            </div>
        );


        // --- 2. DASHBOARD ---
        // --- 2. DASHBOARD ---
        const Dashboard = ({ user, onLogout }) => {
            const [tab, setTab] = useState('menu');
            const [answers, setAnswers] = useState(null);
            const [dogProfile, setDogProfile] = useState(null);
            const [vaccineData, setVaccineData] = useState(null); // New: Vaccine Record Object
            const [isProfileOpen, setIsProfileOpen] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false); // New: Cloud Saving Indicator

            // Load Data from Firestore on Mount
            useEffect(() => {
                if (!user || !db) return;

                // Firestore Listen (Realtime Sync)
                const unsubscribe = db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setAnswers(data.answers || null);
                        setDogProfile(data.dogProfile || null);
                        setVaccineData(data.vaccineData || null);
                    } else {
                        // New user: Set default structure
                        console.log("New user detected, ready to save.");
                    }
                }, error => {
                    console.error("Error fetching data:", error);
                    // Fallback to local storage if offline/error? (Logic omitted for simplicity, relying on Auth)
                });

                return () => unsubscribe();
            }, [user]);

            // Save Helper
            const saveToCloud = async (field, data) => {
                if (!user || !db) return;
                setIsSyncing(true);
                try {
                    await db.collection('users').doc(user.uid).set({
                        [field]: data
                    }, { merge: true });
                } catch (e) {
                    console.error("Save Error:", e);
                    alert("保存に失敗しました");
                } finally {
                    setTimeout(() => setIsSyncing(false), 500); // Visual delay for UX
                }
            };

            // Wrapped Setters
            const handleProfileSave = (profile) => {
                // Update local (optimistic) and cloud
                setDogProfile(profile);
                saveToCloud('dogProfile', profile);
                setIsProfileOpen(false);
            };

            const handleDiagnosisResult = (result) => {
                setAnswers(result);
                saveToCloud('answers', result);
            };

            const handleVaccineSave = (data) => {
                setVaccineData(data);
                saveToCloud('vaccineData', data);
            };

            const renderContent = () => {
                if (isProfileOpen) return <ProfileEditor current={dogProfile} onSave={handleProfileSave} onCancel={() => setIsProfileOpen(false)} />;

                switch (tab) {
                    case 'menu': return <HomeMenu onNavigate={setTab} profile={dogProfile} hasDiagnosis={!!answers} onEditProfile={() => setIsProfileOpen(true)} />;
                    case 'home': return answers ? <FoodResults answers={answers} onReset={() => handleDiagnosisResult(null)} onShowAll={() => setTab('ranking')} /> : <Diagnosis onResult={handleDiagnosisResult} />;
                    case 'ranking': return <ProductRanking onBack={() => setTab('home')} />;
                    case 'record': return <RecordTab data={vaccineData} onSave={handleVaccineSave} />;
                    case 'event': return <EventsTab />;
                    case 'lost': return <LostTab />;
                    default: return <HomeMenu onNavigate={setTab} profile={dogProfile} hasDiagnosis={!!answers} onEditProfile={() => setIsProfileOpen(true)} />;
                }
            };

            return (
                <div className="min-h-screen bg-theme-base pb-24 fade-in">
                    <header className="fixed top-0 w-full max-w-md mx-auto z-40 bg-theme-base/80 backdrop-blur-md px-6 py-4 flex justify-between items-center shadow-sm">
                        <span onClick={() => { setTab('menu'); setIsProfileOpen(false); }} className="font-serif text-2xl tracking-widest text-theme-text font-medium cursor-pointer">PePre</span>
                        <div className="flex items-center gap-4">
                            {/* Sync Indicator */}
                            {isSyncing && <div className="w-2 h-2 rounded-full bg-theme-secondary animate-ping"></div>}

                            <button onClick={() => setIsProfileOpen(true)} className="w-8 h-8 rounded-full bg-theme-muted overflow-hidden border border-theme-text/10">
                                {dogProfile?.image ? <img src={dogProfile.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-theme-text/30"><IconPaw /></div>}
                            </button>
                            <button onClick={onLogout} className="text-xs text-theme-text/50 hover:text-theme-primary transition-colors">Log out</button>
                        </div>
                    </header>
                    <main className="pt-20 px-6">
                        {renderContent()}
                    </main>
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-lg border-t border-theme-muted flex justify-around py-2 pb-safe z-50">
                        <NavButton active={tab === 'menu'} onClick={() => { setTab('menu'); setIsProfileOpen(false); }} icon={<IconHome active={tab === 'menu'} />} label="ホーム" />
                        <NavButton active={tab === 'record'} onClick={() => { setTab('record'); setIsProfileOpen(false); }} icon={<IconRecord active={tab === 'record'} />} label="記録" />
                        <NavButton active={tab === 'event'} onClick={() => { setTab('event'); setIsProfileOpen(false); }} icon={<IconEvent active={tab === 'event'} />} label="イベント" />
                        <NavButton active={tab === 'lost'} onClick={() => { setTab('lost'); setIsProfileOpen(false); }} icon={<IconLost active={tab === 'lost'} />} label="迷子" />
                    </nav>
                </div>
            );
        };

        const ProfileEditor = ({ current, onSave, onCancel }) => {
            const [name, setName] = useState(current?.name || '');
            const [breed, setBreed] = useState(current?.breed || '');
            const [age, setAge] = useState(current?.age || '');
            const [image, setImage] = useState(current?.image || null);

            const handleImageConfig = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fade-in">
                    <div className="text-center mb-6">
                        <h2 className="font-serif text-xl text-theme-text mb-2">My Partner</h2>
                        <p className="text-xs text-theme-text/60">愛犬の情報を登録・編集します</p>
                    </div>

                    <div className="flex flex-col gap-6">
                        {/* Image Upload */}
                        <div className="flex justify-center">
                            <label className="relative w-28 h-28 rounded-full bg-theme-muted border-2 border-theme-muted overflow-hidden flex items-center justify-center cursor-pointer shadow-inner">
                                {image ? <img src={image} className="w-full h-full object-cover" /> : <IconPaw />}
                                <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                                    <span className="text-[10px] text-white font-bold bg-black/50 px-2 py-1 rounded">CHANGE</span>
                                </div>
                                <input type="file" accept="image/*" className="hidden" onChange={handleImageConfig} />
                            </label>
                        </div>

                        {/* Fields */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-theme-text/50 mb-1 tracking-widest uppercase">Name</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="お名前" className="w-full p-4 rounded-xl bg-white border border-theme-muted outline-none focus:border-theme-primary transition-colors text-theme-text" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-theme-text/50 mb-1 tracking-widest uppercase">Breed</label>
                                    <input type="text" value={breed} onChange={e => setBreed(e.target.value)} placeholder="犬種" className="w-full p-4 rounded-xl bg-white border border-theme-muted outline-none focus:border-theme-primary transition-colors text-theme-text" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-theme-text/50 mb-1 tracking-widest uppercase">Age</label>
                                    <input type="text" value={age} onChange={e => setAge(e.target.value)} placeholder="年齢" className="w-full p-4 rounded-xl bg-white border border-theme-muted outline-none focus:border-theme-primary transition-colors text-theme-text" />
                                </div>
                            </div>
                        </div>

                        {/* Actions */}
                        <button onClick={() => onSave({ name, breed, age, image })} className="w-full py-4 bg-theme-primary text-white rounded-xl shadow-lg hover:brightness-110 transition-all font-serif tracking-widest mt-4">
                            SAVE PROFILE
                        </button>
                        <button onClick={onCancel} className="w-full py-3 text-theme-text/50 text-xs tracking-widest hover:text-theme-text transition-colors">
                            CANCEL
                        </button>
                    </div>
                </div>
            );
        };

        const HomeMenu = ({ onNavigate, profile, hasDiagnosis, onEditProfile }) => (
            <div className="flex flex-col gap-6 fade-in">
                {/* Profile Header simulated in Menu */}
                <div onClick={onEditProfile} className="bg-white p-6 rounded-3xl shadow-sm border border-theme-muted/50 flex items-center gap-4 cursor-pointer hover:shadow-soft transition-all">
                    <div className="w-16 h-16 rounded-full bg-theme-muted overflow-hidden flex-shrink-0 border border-theme-text/5">
                        {profile?.image ? <img src={profile.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-theme-text/20 scale-150"><IconPaw /></div>}
                    </div>
                    <div className="flex-1">
                        <h2 className="font-serif text-xl text-theme-text">{profile?.name || "No Name"}</h2>
                        <p className="text-xs text-theme-text/50">{profile?.breed ? `${profile.breed} / ${profile.age}歳` : "プロフィール未登録"}</p>
                    </div>
                    <div className="text-theme-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <MenuButton
                        onClick={() => onNavigate('home')}
                        icon={<IconFood />}
                        title="フード診断"
                        desc={hasDiagnosis ? "診断結果" : "未診断"}
                        accent={!hasDiagnosis}
                    />
                    <MenuButton onClick={() => onNavigate('record')} icon={<IconHealth />} title="ヘルスケア" desc="0 Records" />
                    <MenuButton onClick={() => onNavigate('event')} icon={<IconEventNews />} title="イベント" desc="New 3" />
                    <MenuButton onClick={() => onNavigate('lost')} icon={<IconLostFound />} title="迷子掲示板" desc="Safe" />
                </div>
            </div>
        );

        const MenuButton = ({ onClick, icon, title, desc, accent }) => (
            <button onClick={onClick} className={`p-6 rounded-3xl text-center flex flex-col items-center gap-3 transition-all duration-300 active:scale-95 group ${accent ? 'bg-theme-text text-white shadow-lg' : 'bg-white text-theme-text shadow-sm hover:shadow-soft'}`}>
                <div className={`p-3 rounded-full ${accent ? 'bg-white/10' : 'bg-theme-muted/50 text-theme-primary'}`}>
                    {React.cloneElement(icon, { className: `w-8 h-8 ${accent ? 'text-white' : 'text-theme-primary'}` })}
                </div>
                <div>
                    <h3 className="font-serif text-base mb-1">{title}</h3>
                    <p className={`text-[10px] ${accent ? 'text-white/60' : 'text-theme-text/40'}`}>{desc}</p>
                </div>
            </button>
        );

        const NavButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 w-16 py-2 transition-all duration-500 ${active ? 'text-theme-primary' : 'text-theme-text/30'}`}>
                {icon}
                <span className="text-[10px] font-medium">{label}</span>
            </button>
        );

        // --- DASHBOARD SUB-COMPONENTS (Refined) ---
        const Diagnosis = ({ onResult }) => {
            const [step, setStep] = useState(0);
            const [answers, setAnswers] = useState({});
            const [breedTab, setBreedTab] = useState(BREED_TABS[0]);

            const submit = (key, val) => {
                const next = { ...answers, [key]: val };
                setAnswers(next);
                key === 'concern' ? onResult(next) : setStep(s => s + 1);
            };

            const steps = [
                { t: "犬種をお選びください", c: <BreedSelector tab={breedTab} setTab={setBreedTab} submit={submit} /> },
                { t: "年齢のステージは？", c: <AgeSelector submit={submit} /> },
                { t: "気になることはありますか？", c: <ConcernSelector submit={submit} /> },
            ];

            return (
                <div className="h-full flex flex-col pt-4 fade-in">
                    <div className="text-center mb-10">
                        <h2 className="text-xl font-serif text-theme-text">{steps[step].t}</h2>
                    </div>
                    {steps[step].c}
                </div>
            );
        };

        const BreedSelector = ({ tab, setTab, submit }) => (
            <div className="flex flex-col">
                <div className="flex gap-4 overflow-x-auto pb-4 mb-4 hide-scroll px-1">
                    {BREED_TABS.map(t => <button key={t} onClick={() => setTab(t)} className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-sm font-serif transition-all duration-300 ${tab === t ? 'bg-theme-text text-theme-base shadow-lg scale-110' : 'bg-white text-theme-text/50'}`}>{t}</button>)}
                </div>
                <div className="grid grid-cols-2 gap-3 pb-20">
                    {BREEDS[tab].map(b => <button key={b} onClick={() => submit('breed', b)} className="p-4 text-center text-sm bg-white rounded-xl shadow-sm text-theme-text hover:shadow-soft transition-all">{b}</button>)}
                </div>
            </div>
        );

        const AgeSelector = ({ submit }) => (
            <div className="space-y-4">
                {[{ l: "Puppy", jp: "子犬", sub: "〜1歳" }, { l: "Adult", jp: "成犬", sub: "1〜7歳" }, { l: "Senior", jp: "シニア", sub: "7歳〜" }]
                    .map(o => (
                        <button key={o.l} onClick={() => submit('age', o.l)} className="w-full bg-white p-6 rounded-2xl shadow-sm hover:shadow-soft transition-all duration-300 group text-left flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <IconPaw />
                                <span className="font-serif text-lg text-theme-text">{o.jp}</span>
                            </div>
                            <span className="text-xs text-theme-text/30 font-sans">{o.sub}</span>
                        </button>
                    ))}
            </div>
        );

        const ConcernSelector = ({ submit }) => (
            <div className="grid grid-cols-2 gap-3">
                {[{ l: "Tear Burn", jp: "涙やけ", v: 'tear_burn', icon: <IconEye /> }, { l: "Coat", jp: "毛並み", v: 'coat', icon: <IconCoat /> }, { l: "Joints", jp: "関節", v: 'joints', icon: <IconBone /> }, { l: "Weight", jp: "体重管理", v: 'obesity', icon: <IconWeight /> }, { l: "Appetite", jp: "食いつき", v: 'appetite', icon: <IconBowl /> }, { l: "Teeth", jp: "歯のケア", v: 'teeth', icon: <IconPaw /> }, { l: "Odor", jp: "口臭・ニオイ", v: 'odor', icon: <IconSparkles /> }]
                    .map(o => (
                        <button key={o.v} onClick={() => submit('concern', [o.v])} className="aspect-square bg-white rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-soft transition-all active:scale-95">
                            {o.icon}
                            <span className="font-serif text-theme-text">{o.jp}</span>
                        </button>
                    ))}
            </div>
        );

        const FoodResults = ({ answers, onReset, onShowAll }) => {
            const results = useMemo(() => {
                if (!answers) return [];
                const userAge = answers.age || 'Adult'; // Default
                const userConcerns = answers.concern || []; // Array

                return PRODUCTS
                    .map(p => {
                        let score = 0;
                        // 1. Quality/Priority (User Satisfaction)
                        if (p.tags.priority === 'S') score += 50;
                        if (p.tags.priority === 'A') score += 30;
                        if (p.tags.priority === 'B') score += 10;

                        // 2. Age Match
                        const pAge = p.tags.age;
                        let isAgeMatch = false;
                        if (pAge === 'all') isAgeMatch = true;
                        else if (pAge.toLowerCase() === userAge.toLowerCase()) isAgeMatch = true;

                        if (!isAgeMatch) return null; // Filter out mismatched age

                        // 3. Concern Match
                        if (userConcerns.includes(p.tags.concern)) score += 40;
                        const secondaryMatch = p.tags.secondaryConcern.some(c => userConcerns.includes(c));
                        if (secondaryMatch) score += 20;

                        return { ...p, score };
                    })
                    .filter(Boolean) // Remove nulls
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);
            }, [answers]);

            return (
                <div className="pb-24 fade-in">
                    <div className="text-center mb-8">
                        <p className="font-serif text-lg mb-2">My Best Selection</p>
                        <p className="text-xs text-theme-text/50 font-sans">
                            {answers.breed} / {answers.age === 'Puppy' ? '子犬' : answers.age === 'Senior' ? 'シニア' : '成犬'}
                            <br />
                            <span className="text-[10px] mt-1 inline-block bg-theme-muted px-2 py-0.5 rounded-full">
                                Priority: Quality & Satisfaction
                            </span>
                        </p>
                    </div>
                    <div className="space-y-8">
                        {results.map((p, i) => (
                            <div key={p.id} className="group cursor-pointer" onClick={() => p.link && window.open(p.link, '_blank')}>
                                <div className="relative aspect-[4/3] rounded-2xl overflow-hidden mb-4 shadow-float">
                                    <div className="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full z-10">
                                        <span className="text-[10px] font-bold tracking-widest uppercase text-theme-text">No.0{i + 1} Match</span>
                                    </div>
                                    {p.tags.priority === 'S' && (
                                        <div className="absolute top-4 right-4 bg-theme-primary/90 backdrop-blur px-3 py-1 rounded-full z-10 text-white">
                                            <span className="text-[10px] font-bold tracking-widest uppercase">Premium</span>
                                        </div>
                                    )}
                                    <img src={p.img} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                </div>
                                <div className="text-center px-2">
                                    <span className="text-[10px] text-theme-primary tracking-widest uppercase block mb-2">{p.feature}</span>
                                    <h3 className="font-serif text-xl text-theme-text mb-2">{p.name}</h3>
                                    <p className="text-sm text-theme-text/60 leading-relaxed mb-3">{p.description}</p>
                                    {/* Price less prominent as requested */}
                                    <p className="text-xs text-theme-text/40 mb-4 font-sans border-b border-transparent inline-block group-hover:border-theme-primary/30 transition-all">Go to Official Site</p>

                                    <button className="w-full bg-theme-text text-white text-xs px-6 py-4 rounded-xl shadow-lg hover:bg-theme-text/90 transition-all uppercase tracking-widest">
                                        公式サイトを見る
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <button onClick={onShowAll} className="w-full mt-10 bg-theme-secondary/10 text-theme-secondary py-4 rounded-xl font-bold tracking-widest border border-theme-secondary/20 hover:bg-theme-secondary hover:text-white transition-all">
                        2026プレミアムドッグフード一覧
                    </button>
                    <button onClick={onReset} className="w-full mt-4 text-xs text-theme-text/40 tracking-widest uppercase hover:text-theme-primary transition-colors border-t border-theme-muted/30">もう一度診断する</button>
                </div>
            );
        };

        const ProductRanking = ({ onBack }) => {
            // Sort by Priority S -> A -> B
            const sorted = useMemo(() => {
                const priorityOrder = { 'S': 3, 'A': 2, 'B': 1 };
                return [...PRODUCTS].sort((a, b) => priorityOrder[b.tags.priority] - priorityOrder[a.tags.priority]);
            }, []);

            return (
                <div className="pb-24 fade-in pt-4">
                    <div className="text-center mb-10 relative">
                        <button onClick={onBack} className="absolute left-0 top-1 text-theme-text/50 hover:text-theme-text">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <h2 className="text-xl font-serif text-theme-text">Collection 2026</h2>
                        <p className="text-[10px] text-theme-text/50 tracking-widest uppercase mt-1">Premium Dog Foods</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        {sorted.map((p) => (
                            <div key={p.id} className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer" onClick={() => p.link && window.open(p.link, '_blank')}>
                                <div className="aspect-square relative">
                                    <img src={p.img} className="w-full h-full object-cover" />
                                    {p.tags.priority === 'S' && <span className="absolute top-2 right-2 bg-theme-primary text-white text-[10px] px-2 py-0.5 rounded-full font-bold">Recommended</span>}
                                </div>
                                <div className="p-3">
                                    <h3 className="font-serif text-sm text-theme-text mb-1 line-clamp-1">{p.name}</h3>
                                    <p className="text-[10px] text-theme-text/50 line-clamp-2">{p.description}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const RecordTab = ({ data, onSave }) => {
            // data format: { mixedDate, mixedType, rabiesDate, hospitalMemo }
            // If data is null/undefined, default to empty
            const safeData = data || {};

            const handleChange = (field, value) => {
                onSave({ ...safeData, [field]: value });
            };

            // Calculate next dates
            const getNextDate = (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                d.setFullYear(d.getFullYear() + 1);
                return d.toLocaleDateString();
            };

            const nextMixed = getNextDate(safeData.mixedDate);
            const nextRabies = getNextDate(safeData.rabiesDate);

            return (
                <div className="fade-in pt-4 pb-20">
                    <div className="text-center mb-10">
                        <h2 className="text-xl font-serif text-theme-text">ワクチン管理</h2>
                        <p className="text-[10px] text-theme-text/50 mt-1">大切な記録をクラウドに保存</p>
                    </div>

                    {/* Mixed Vaccine */}
                    <div className="bg-white p-6 rounded-3xl shadow-sm mb-6 border border-theme-primary/10">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="w-8 h-8 rounded-full bg-theme-primary/10 text-theme-primary flex items-center justify-center">
                                <IconHealth />
                            </span>
                            <h3 className="font-serif text-theme-text">混合ワクチン</h3>
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-[10px] tracking-widest text-theme-text/50 uppercase mb-1">接種日</label>
                                <input type="date" value={safeData.mixedDate || ''} onChange={(e) => handleChange('mixedDate', e.target.value)} className="w-full bg-theme-base/50 p-2 rounded-lg text-sm text-theme-text outline-none focus:ring-1 focus:ring-theme-primary/50" />
                            </div>
                            <div>
                                <label className="block text-[10px] tracking-widest text-theme-text/50 uppercase mb-1">種類</label>
                                <select value={safeData.mixedType || '5種'} onChange={(e) => handleChange('mixedType', e.target.value)} className="w-full bg-theme-base/50 p-2 rounded-lg text-sm text-theme-text outline-none focus:ring-1 focus:ring-theme-primary/50">
                                    <option>5種</option>
                                    <option>6種</option>
                                    <option>7種</option>
                                    <option>8種</option>
                                    <option>10種</option>
                                </select>
                            </div>
                        </div>
                        {nextMixed && (
                            <div className="text-center bg-theme-primary/5 rounded-xl p-3">
                                <p className="text-[10px] text-theme-primary/60 mb-1">次回の予定</p>
                                <p className="font-serif text-lg text-theme-primary">{nextMixed}</p>
                            </div>
                        )}
                    </div>

                    {/* Rabies Vaccine */}
                    <div className="bg-white p-6 rounded-3xl shadow-sm mb-6 border border-theme-secondary/10">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="w-8 h-8 rounded-full bg-theme-secondary/10 text-theme-secondary flex items-center justify-center">
                                <IconPaw />
                            </span>
                            <h3 className="font-serif text-theme-text">狂犬病ワクチン</h3>
                        </div>
                        <div className="mb-4">
                            <label className="block text-[10px] tracking-widest text-theme-text/50 uppercase mb-1">接種日</label>
                            <input type="date" value={safeData.rabiesDate || ''} onChange={(e) => handleChange('rabiesDate', e.target.value)} className="w-full bg-theme-base/50 p-3 rounded-lg text-sm text-theme-text outline-none focus:ring-1 focus:ring-theme-secondary/50" />
                        </div>
                        {nextRabies && (
                            <div className="text-center bg-theme-secondary/5 rounded-xl p-3">
                                <p className="text-[10px] text-theme-secondary/60 mb-1">次回の予定</p>
                                <p className="font-serif text-lg text-theme-secondary">{nextRabies}</p>
                            </div>
                        )}
                    </div>

                    {/* Hospital Memo */}
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-theme-muted">
                        <label className="block text-[10px] tracking-widest text-theme-text/50 uppercase mb-2">かかりつけ病院メモ</label>
                        <textarea
                            value={safeData.hospitalMemo || ''}
                            onChange={(e) => handleChange('hospitalMemo', e.target.value)}
                            placeholder="病院名や住所、診察券番号など..."
                            className="w-full h-24 bg-theme-base/50 p-3 rounded-xl text-sm text-theme-text resize-none outline-none focus:ring-1 focus:ring-theme-muted"
                        ></textarea>
                    </div>
                </div>
            );
        };

        const EventsTab = () => {
            // Helper to sort events by date
            const sortedEvents = useMemo(() => {
                const parseDate = (dStr) => {
                    // "3月20日-22日" -> 0320 for sorting
                    const match = dStr.match(/(\d+)月(\d+)日/);
                    if (!match) return 9999;
                    return parseInt(match[1]) * 100 + parseInt(match[2]);
                };
                return [...EVENTS_DATA].sort((a, b) => parseDate(a.date) - parseDate(b.date));
            }, []);

            return (
                <div className="fade-in pt-4">
                    <div className="text-center mb-10">
                        <h2 className="text-xl font-serif text-theme-text">イベント情報</h2>
                    </div>
                    <div className="space-y-4">
                        {sortedEvents.map((e, i) => {
                            // Extract prefecture from "東京都 舎人公園" -> "東京都"
                            const prefecture = e.place.split(' ')[0] || "関東";
                            return (
                                <div key={i} className="bg-white rounded-2xl p-4 shadow-sm flex gap-5 items-center hover:shadow-md transition-shadow cursor-pointer">
                                    {/* Prefecture Box (Replaces Image) */}
                                    <div className="w-20 h-20 rounded-xl bg-theme-muted/30 flex items-center justify-center flex-shrink-0 border border-theme-muted">
                                        <span className="font-serif text-lg text-theme-text font-medium writing-vertical-rl tracking-widest leading-none h-12">
                                            {prefecture}
                                        </span>
                                    </div>

                                    <div className="flex-1 min-w-0">
                                        <span className="text-[10px] font-bold tracking-wider text-theme-primary/80 uppercase mb-1 block">{e.date}</span>
                                        <h3 className="font-serif text-lg text-theme-text mb-2 leading-tight">{e.title}</h3>
                                        <div className="flex items-center gap-2 text-xs text-theme-text/50 font-sans truncate">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3 flex-shrink-0">
                                                <path fillRule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.273 1.765 11.842 11.842 0 00.976.544l.062.029.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clipRule="evenodd" />
                                            </svg>
                                            {e.place}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const LostTab = () => (
            <div className="fade-in pt-4">
                <div className="text-center mb-10">
                    <h2 className="text-xl font-serif text-theme-text">迷子情報</h2>
                </div>
                <div className="space-y-4">
                    {LOST_DATA.length > 0 ? (
                        LOST_DATA.map(d => (
                            <div key={d.id} className="bg-white rounded-2xl p-4 shadow-sm flex gap-4 items-center">
                                <img src={d.img} className="w-12 h-12 rounded-full object-cover" />
                                <div>
                                    <p className="font-serif text-theme-text">{d.name} <span className="text-xs text-theme-text/50 font-sans ml-2">({d.breed})</span></p>
                                    <p className="text-xs text-theme-text/40 mt-1">📍 {d.place}</p>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-20 bg-white/50 rounded-3xl border border-theme-muted/50">
                            <div className="inline-block p-4 bg-theme-muted rounded-full text-theme-primary mb-4">
                                <IconLostFound />
                            </div>
                            <p className="text-theme-text font-serif mb-2">現在迷子情報はありません</p>
                            <p className="text-[10px] text-theme-text/50">平和な一日です</p>
                        </div>
                    )}
                </div>
            </div>
        );


        // --- MAIN ENTRY POINT ---
        const App = () => {
            const [user, setUser] = useState(null); // Auth User Object
            const [isLoading, setIsLoading] = useState(true); // Initial Check

            // Auth Persistence Logic
            useEffect(() => {
                if (typeof firebase === 'undefined') return;

                // Infinite persistence (default in Firebase w/ CDN, but explicit here doesn't hurt)
                // firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);

                const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
                    setUser(u); // If logged in, u object exists. If not, null.
                    setIsLoading(false); // Auth check done
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = () => {
                if (typeof firebase === 'undefined') {
                    alert("Firebase SDK not loaded. Check internet connection.");
                    return;
                }
                const auth = firebase.auth();
                const provider = new firebase.auth.GoogleAuthProvider();

                auth.signInWithPopup(provider).catch((error) => {
                    console.error("Login failed", error);
                    alert(`Login Failed: ${error.message}`);
                });
            };

            const handleLogout = () => {
                firebase.auth().signOut();
            };

            if (isLoading) {
                return (
                    <div className="w-full max-w-md mx-auto min-h-screen bg-theme-base flex items-center justify-center">
                        <div className="animate-pulse text-theme-primary font-serif">Loading PePre...</div>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-md mx-auto shadow-2xl min-h-screen bg-theme-base overflow-hidden relative">
                    {user ? <Dashboard user={user} onLogout={handleLogout} /> : <LandingPage onLogin={handleLogin} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>